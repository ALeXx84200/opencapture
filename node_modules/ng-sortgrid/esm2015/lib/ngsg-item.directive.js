/**
 * @fileoverview added by tsickle
 * Generated from: lib/ngsg-item.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { takeUntil, takeWhile, throttleTime } from 'rxjs/operators';
import { NgsgElementsHelper } from './helpers/element/ngsg-elements.helper';
import { ScrollHelperService } from './helpers/scroll/scroll-helper.service';
import { NgsgSelectionService } from './mutliselect/ngsg-selection.service';
import { NgsgEventsService } from './shared/ngsg-events.service';
import { NgsgReflectService } from './sort/reflection/ngsg-reflect.service';
import { NgsgSortService } from './sort/sort/ngsg-sort.service';
import { NgsgStoreService } from './store/ngsg-store.service';
/** @type {?} */
const selector = '[ngSortgridItem]';
export class NgsgItemDirective {
    /**
     * @param {?} el
     * @param {?} sortService
     * @param {?} selectionService
     * @param {?} reflectService
     * @param {?} ngsgStore
     * @param {?} ngsgEventService
     * @param {?} scrollHelperService
     */
    constructor(el, sortService, selectionService, reflectService, ngsgStore, ngsgEventService, scrollHelperService) {
        this.el = el;
        this.sortService = sortService;
        this.selectionService = selectionService;
        this.reflectService = reflectService;
        this.ngsgStore = ngsgStore;
        this.ngsgEventService = ngsgEventService;
        this.scrollHelperService = scrollHelperService;
        this.ngSortGridGroup = 'defaultGroup';
        this.autoScroll = false;
        this.sorted = new EventEmitter();
        this.selected = false;
        this.destroy$ = new Subject();
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.ngsgEventService.dropped$.pipe(takeUntil(this.destroy$)).subscribe((/**
         * @return {?}
         */
        () => this.selected = false));
        fromEvent(this.el.nativeElement, 'drag').pipe(throttleTime(20), takeUntil(this.destroy$), takeWhile((/**
         * @return {?}
         */
        () => this.autoScroll))).subscribe((/**
         * @return {?}
         */
        () => {
            this.scrollHelperService.scrollIfNecessary(event, {
                top: this.scrollPointTop,
                bottom: this.scrollPointBottom
            }, this.scrollSpeed);
        }));
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        /** @type {?} */
        const sortGridItemChanges = changes.ngSortGridItems;
        /** @type {?} */
        const sortGridItems = sortGridItemChanges.currentValue ? sortGridItemChanges.currentValue : [];
        if (!this.ngsgStore.hasGroup(this.ngSortGridGroup)) {
            this.ngsgStore.initState(this.ngSortGridGroup, sortGridItems);
            return;
        }
        this.ngsgStore.setItems(this.ngSortGridGroup, sortGridItems);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.el.nativeElement.draggable = true;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    /**
     * @param {?} event
     * @return {?}
     */
    dragStart(event) {
        if (!this.occuredOnHost(event)) {
            return;
        }
        this.selectionService.selectElementIfNoSelection(this.ngSortGridGroup, event.target);
        this.sortService.initSort(this.ngSortGridGroup);
    }
    /**
     * @return {?}
     */
    dragEnter() {
        if (!this.ngsgStore.hasSelectedItems(this.ngSortGridGroup)) {
            return;
        }
        this.sortService.sort(this.el.nativeElement);
    }
    /**
     * @param {?} event
     * @return {?}
     */
    dragOver(event) {
        if (event.preventDefault) {
            // Necessary. Allows us to drop.
            event.preventDefault();
        }
        return false;
    }
    /**
     * @return {?}
     */
    drop() {
        if (!this.ngsgStore.hasSelectedItems(this.ngSortGridGroup)) {
            return;
        }
        if (!this.ngsgStore.hasItems(this.ngSortGridGroup)) {
            console.warn(`Ng-sortgrid: No items provided - please use [sortGridItems] to pass in an array of items -
      otherwhise the ordered items can not be emitted in the (sorted) event`);
            return;
        }
        /** @type {?} */
        const previousOrder = [...this.ngsgStore.getItems(this.ngSortGridGroup)];
        this.sortService.endSort();
        /** @type {?} */
        const currentOrder = this.reflectService.reflectChanges(this.ngSortGridGroup, this.el.nativeElement);
        this.sorted.next({ previousOrder, currentOrder });
        this.ngsgStore.resetSelectedItems(this.ngSortGridGroup);
        this.ngsgEventService.dropped$.next();
    }
    /**
     * @return {?}
     */
    clicked() {
        this.selected = !this.isItemCurrentlySelected();
        this.selectionService.updateSelectedDragItem(this.ngSortGridGroup, this.el.nativeElement, this.selected);
    }
    /**
     * @private
     * @return {?}
     */
    isItemCurrentlySelected() {
        /** @type {?} */
        const index = NgsgElementsHelper.findIndex(this.el.nativeElement);
        return !!this.ngsgStore.getSelectedItems(this.ngSortGridGroup)
            .find((/**
         * @param {?} element
         * @return {?}
         */
        element => element.originalIndex === index));
    }
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    occuredOnHost(event) {
        return event.target.matches(selector);
    }
}
NgsgItemDirective.decorators = [
    { type: Directive, args: [{ selector },] }
];
/** @nocollapse */
NgsgItemDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: NgsgSortService },
    { type: NgsgSelectionService },
    { type: NgsgReflectService },
    { type: NgsgStoreService },
    { type: NgsgEventsService },
    { type: ScrollHelperService }
];
NgsgItemDirective.propDecorators = {
    ngSortGridGroup: [{ type: Input }],
    ngSortGridItems: [{ type: Input }],
    scrollPointTop: [{ type: Input }],
    scrollPointBottom: [{ type: Input }],
    scrollSpeed: [{ type: Input }],
    autoScroll: [{ type: Input }],
    sorted: [{ type: Output }],
    dragStart: [{ type: HostListener, args: ['dragstart', ['$event'],] }],
    dragEnter: [{ type: HostListener, args: ['dragenter',] }],
    dragOver: [{ type: HostListener, args: ['dragover', ['$event'],] }],
    drop: [{ type: HostListener, args: ['dragend',] }],
    clicked: [{ type: HostListener, args: ['click',] }]
};
if (false) {
    /** @type {?} */
    NgsgItemDirective.prototype.ngSortGridGroup;
    /** @type {?} */
    NgsgItemDirective.prototype.ngSortGridItems;
    /** @type {?} */
    NgsgItemDirective.prototype.scrollPointTop;
    /** @type {?} */
    NgsgItemDirective.prototype.scrollPointBottom;
    /** @type {?} */
    NgsgItemDirective.prototype.scrollSpeed;
    /** @type {?} */
    NgsgItemDirective.prototype.autoScroll;
    /** @type {?} */
    NgsgItemDirective.prototype.sorted;
    /**
     * @type {?}
     * @private
     */
    NgsgItemDirective.prototype.selected;
    /**
     * @type {?}
     * @private
     */
    NgsgItemDirective.prototype.destroy$;
    /** @type {?} */
    NgsgItemDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    NgsgItemDirective.prototype.sortService;
    /**
     * @type {?}
     * @private
     */
    NgsgItemDirective.prototype.selectionService;
    /**
     * @type {?}
     * @private
     */
    NgsgItemDirective.prototype.reflectService;
    /**
     * @type {?}
     * @private
     */
    NgsgItemDirective.prototype.ngsgStore;
    /**
     * @type {?}
     * @private
     */
    NgsgItemDirective.prototype.ngsgEventService;
    /**
     * @type {?}
     * @private
     */
    NgsgItemDirective.prototype.scrollHelperService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmdzZy1pdGVtLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25nLXNvcnRncmlkL3NyYy9saWIvbmdzZy1pdGVtLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFFTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixZQUFZLEVBQ1osS0FBSyxFQUlMLE1BQU0sRUFFUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUMsU0FBUyxFQUFFLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN4QyxPQUFPLEVBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUVsRSxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSx3Q0FBd0MsQ0FBQztBQUMxRSxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSx3Q0FBd0MsQ0FBQztBQUMzRSxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSxzQ0FBc0MsQ0FBQztBQUMxRSxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUUvRCxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSx3Q0FBd0MsQ0FBQztBQUMxRSxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sK0JBQStCLENBQUM7QUFDOUQsT0FBTyxFQUFDLGdCQUFnQixFQUFDLE1BQU0sNEJBQTRCLENBQUM7O01BRXRELFFBQVEsR0FBRyxrQkFBa0I7QUFHbkMsTUFBTSxPQUFPLGlCQUFpQjs7Ozs7Ozs7OztJQWE1QixZQUNTLEVBQWMsRUFDYixXQUE0QixFQUM1QixnQkFBc0MsRUFDdEMsY0FBa0MsRUFDbEMsU0FBMkIsRUFDM0IsZ0JBQW1DLEVBQ25DLG1CQUF3QztRQU56QyxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQ2IsZ0JBQVcsR0FBWCxXQUFXLENBQWlCO1FBQzVCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBc0I7UUFDdEMsbUJBQWMsR0FBZCxjQUFjLENBQW9CO1FBQ2xDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBbUI7UUFDbkMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQW5CekMsb0JBQWUsR0FBRyxjQUFjLENBQUM7UUFLakMsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUVsQixXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQXdCLENBQUM7UUFFcEQsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUNqQixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQVdqQyxDQUFDOzs7O0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUNqQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUN6QixDQUFDLFNBQVM7OztRQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxFQUFDLENBQUM7UUFFekMsU0FBUyxDQUFZLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FDdEQsWUFBWSxDQUFDLEVBQUUsQ0FBQyxFQUNoQixTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUN4QixTQUFTOzs7UUFBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFDLENBQ2pDLENBQUMsU0FBUzs7O1FBQUMsR0FBRyxFQUFFO1lBQ2IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGlCQUFpQixDQUFDLEtBQUssRUFBRTtnQkFDaEQsR0FBRyxFQUFFLElBQUksQ0FBQyxjQUFjO2dCQUN4QixNQUFNLEVBQUUsSUFBSSxDQUFDLGlCQUFpQjthQUMvQixFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN2QixDQUFDLEVBQ0YsQ0FBQztJQUNKLENBQUM7Ozs7O0lBRUQsV0FBVyxDQUFDLE9BQXNCOztjQUMxQixtQkFBbUIsR0FBRyxPQUFPLENBQUMsZUFBZTs7Y0FDN0MsYUFBYSxHQUFHLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBRTlGLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUU7WUFDbEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUM5RCxPQUFPO1NBQ1I7UUFDRCxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQy9ELENBQUM7Ozs7SUFFRCxlQUFlO1FBQ2IsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztJQUN6QyxDQUFDOzs7O0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUMzQixDQUFDOzs7OztJQUdELFNBQVMsQ0FBQyxLQUFLO1FBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDOUIsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3JGLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUNsRCxDQUFDOzs7O0lBR0QsU0FBUztRQUNQLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRTtZQUMxRCxPQUFPO1NBQ1I7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQy9DLENBQUM7Ozs7O0lBR0QsUUFBUSxDQUFDLEtBQUs7UUFDWixJQUFJLEtBQUssQ0FBQyxjQUFjLEVBQUU7WUFDeEIsZ0NBQWdDO1lBQ2hDLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztTQUN4QjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQzs7OztJQUdELElBQUk7UUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUU7WUFDMUQsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRTtZQUNsRCxPQUFPLENBQUMsSUFBSSxDQUFDOzRFQUN5RCxDQUFDLENBQUM7WUFDeEUsT0FBTztTQUNSOztjQUNLLGFBQWEsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3hFLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7O2NBQ3JCLFlBQVksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDO1FBQ3BHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUMsYUFBYSxFQUFFLFlBQVksRUFBQyxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN4QyxDQUFDOzs7O0lBR0QsT0FBTztRQUNMLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUNoRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDM0csQ0FBQzs7Ozs7SUFFTyx1QkFBdUI7O2NBQ3ZCLEtBQUssR0FBRyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUM7UUFDakUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDO2FBQzNELElBQUk7Ozs7UUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEtBQUssS0FBSyxFQUFDLENBQUM7SUFDdEQsQ0FBQzs7Ozs7O0lBRU8sYUFBYSxDQUFDLEtBQUs7UUFDekIsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN4QyxDQUFDOzs7WUExSEYsU0FBUyxTQUFDLEVBQUMsUUFBUSxFQUFDOzs7O1lBeEJuQixVQUFVO1lBbUJKLGVBQWU7WUFKZixvQkFBb0I7WUFHcEIsa0JBQWtCO1lBRWxCLGdCQUFnQjtZQUpoQixpQkFBaUI7WUFGakIsbUJBQW1COzs7OEJBWXhCLEtBQUs7OEJBQ0wsS0FBSzs2QkFDTCxLQUFLO2dDQUNMLEtBQUs7MEJBQ0wsS0FBSzt5QkFDTCxLQUFLO3FCQUVMLE1BQU07d0JBc0ROLFlBQVksU0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUM7d0JBU3BDLFlBQVksU0FBQyxXQUFXO3VCQVF4QixZQUFZLFNBQUMsVUFBVSxFQUFFLENBQUMsUUFBUSxDQUFDO21CQVNuQyxZQUFZLFNBQUMsU0FBUztzQkFtQnRCLFlBQVksU0FBQyxPQUFPOzs7O0lBMUdyQiw0Q0FBMEM7O0lBQzFDLDRDQUFnQzs7SUFDaEMsMkNBQWdDOztJQUNoQyw4Q0FBbUM7O0lBQ25DLHdDQUE2Qjs7SUFDN0IsdUNBQTRCOztJQUU1QixtQ0FBNEQ7Ozs7O0lBRTVELHFDQUF5Qjs7Ozs7SUFDekIscUNBQWlDOztJQUcvQiwrQkFBcUI7Ozs7O0lBQ3JCLHdDQUFvQzs7Ozs7SUFDcEMsNkNBQThDOzs7OztJQUM5QywyQ0FBMEM7Ozs7O0lBQzFDLHNDQUFtQzs7Ozs7SUFDbkMsNkNBQTJDOzs7OztJQUMzQyxnREFBZ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBEaXJlY3RpdmUsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSG9zdExpc3RlbmVyLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBTaW1wbGVDaGFuZ2VzXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtmcm9tRXZlbnQsIFN1YmplY3R9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHt0YWtlVW50aWwsIHRha2VXaGlsZSwgdGhyb3R0bGVUaW1lfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7TmdzZ0VsZW1lbnRzSGVscGVyfSBmcm9tICcuL2hlbHBlcnMvZWxlbWVudC9uZ3NnLWVsZW1lbnRzLmhlbHBlcic7XG5pbXBvcnQge1Njcm9sbEhlbHBlclNlcnZpY2V9IGZyb20gJy4vaGVscGVycy9zY3JvbGwvc2Nyb2xsLWhlbHBlci5zZXJ2aWNlJztcbmltcG9ydCB7TmdzZ1NlbGVjdGlvblNlcnZpY2V9IGZyb20gJy4vbXV0bGlzZWxlY3QvbmdzZy1zZWxlY3Rpb24uc2VydmljZSc7XG5pbXBvcnQge05nc2dFdmVudHNTZXJ2aWNlfSBmcm9tICcuL3NoYXJlZC9uZ3NnLWV2ZW50cy5zZXJ2aWNlJztcbmltcG9ydCB7TmdzZ09yZGVyQ2hhbmdlfSBmcm9tICcuL3NoYXJlZC9uZ3NnLW9yZGVyLWNoYW5nZS5tb2RlbCc7XG5pbXBvcnQge05nc2dSZWZsZWN0U2VydmljZX0gZnJvbSAnLi9zb3J0L3JlZmxlY3Rpb24vbmdzZy1yZWZsZWN0LnNlcnZpY2UnO1xuaW1wb3J0IHtOZ3NnU29ydFNlcnZpY2V9IGZyb20gJy4vc29ydC9zb3J0L25nc2ctc29ydC5zZXJ2aWNlJztcbmltcG9ydCB7TmdzZ1N0b3JlU2VydmljZX0gZnJvbSAnLi9zdG9yZS9uZ3NnLXN0b3JlLnNlcnZpY2UnO1xuXG5jb25zdCBzZWxlY3RvciA9ICdbbmdTb3J0Z3JpZEl0ZW1dJztcblxuQERpcmVjdGl2ZSh7c2VsZWN0b3J9KVxuZXhwb3J0IGNsYXNzIE5nc2dJdGVtRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgpIG5nU29ydEdyaWRHcm91cCA9ICdkZWZhdWx0R3JvdXAnO1xuICBASW5wdXQoKSBuZ1NvcnRHcmlkSXRlbXM6IGFueVtdO1xuICBASW5wdXQoKSBzY3JvbGxQb2ludFRvcDogbnVtYmVyO1xuICBASW5wdXQoKSBzY3JvbGxQb2ludEJvdHRvbTogbnVtYmVyO1xuICBASW5wdXQoKSBzY3JvbGxTcGVlZDogbnVtYmVyO1xuICBASW5wdXQoKSBhdXRvU2Nyb2xsID0gZmFsc2U7XG5cbiAgQE91dHB1dCgpIHNvcnRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8TmdzZ09yZGVyQ2hhbmdlPGFueT4+KCk7XG5cbiAgcHJpdmF0ZSBzZWxlY3RlZCA9IGZhbHNlO1xuICBwcml2YXRlIGRlc3Ryb3kkID0gbmV3IFN1YmplY3QoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgZWw6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSBzb3J0U2VydmljZTogTmdzZ1NvcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgc2VsZWN0aW9uU2VydmljZTogTmdzZ1NlbGVjdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWZsZWN0U2VydmljZTogTmdzZ1JlZmxlY3RTZXJ2aWNlLFxuICAgIHByaXZhdGUgbmdzZ1N0b3JlOiBOZ3NnU3RvcmVTZXJ2aWNlLFxuICAgIHByaXZhdGUgbmdzZ0V2ZW50U2VydmljZTogTmdzZ0V2ZW50c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBzY3JvbGxIZWxwZXJTZXJ2aWNlOiBTY3JvbGxIZWxwZXJTZXJ2aWNlXG4gICkge1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5uZ3NnRXZlbnRTZXJ2aWNlLmRyb3BwZWQkLnBpcGUoXG4gICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95JClcbiAgICApLnN1YnNjcmliZSgoKSA9PiB0aGlzLnNlbGVjdGVkID0gZmFsc2UpO1xuXG4gICAgZnJvbUV2ZW50PERyYWdFdmVudD4odGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnZHJhZycpLnBpcGUoXG4gICAgICB0aHJvdHRsZVRpbWUoMjApLFxuICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveSQpLFxuICAgICAgdGFrZVdoaWxlKCgpID0+IHRoaXMuYXV0b1Njcm9sbClcbiAgICApLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuc2Nyb2xsSGVscGVyU2VydmljZS5zY3JvbGxJZk5lY2Vzc2FyeShldmVudCwge1xuICAgICAgICAgIHRvcDogdGhpcy5zY3JvbGxQb2ludFRvcCxcbiAgICAgICAgICBib3R0b206IHRoaXMuc2Nyb2xsUG9pbnRCb3R0b21cbiAgICAgICAgfSwgdGhpcy5zY3JvbGxTcGVlZCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBjb25zdCBzb3J0R3JpZEl0ZW1DaGFuZ2VzID0gY2hhbmdlcy5uZ1NvcnRHcmlkSXRlbXM7XG4gICAgY29uc3Qgc29ydEdyaWRJdGVtcyA9IHNvcnRHcmlkSXRlbUNoYW5nZXMuY3VycmVudFZhbHVlID8gc29ydEdyaWRJdGVtQ2hhbmdlcy5jdXJyZW50VmFsdWUgOiBbXTtcblxuICAgIGlmICghdGhpcy5uZ3NnU3RvcmUuaGFzR3JvdXAodGhpcy5uZ1NvcnRHcmlkR3JvdXApKSB7XG4gICAgICB0aGlzLm5nc2dTdG9yZS5pbml0U3RhdGUodGhpcy5uZ1NvcnRHcmlkR3JvdXAsIHNvcnRHcmlkSXRlbXMpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLm5nc2dTdG9yZS5zZXRJdGVtcyh0aGlzLm5nU29ydEdyaWRHcm91cCwgc29ydEdyaWRJdGVtcyk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5lbC5uYXRpdmVFbGVtZW50LmRyYWdnYWJsZSA9IHRydWU7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdkcmFnc3RhcnQnLCBbJyRldmVudCddKVxuICBkcmFnU3RhcnQoZXZlbnQpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMub2NjdXJlZE9uSG9zdChldmVudCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zZWxlY3Rpb25TZXJ2aWNlLnNlbGVjdEVsZW1lbnRJZk5vU2VsZWN0aW9uKHRoaXMubmdTb3J0R3JpZEdyb3VwLCBldmVudC50YXJnZXQpO1xuICAgIHRoaXMuc29ydFNlcnZpY2UuaW5pdFNvcnQodGhpcy5uZ1NvcnRHcmlkR3JvdXApO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignZHJhZ2VudGVyJylcbiAgZHJhZ0VudGVyKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5uZ3NnU3RvcmUuaGFzU2VsZWN0ZWRJdGVtcyh0aGlzLm5nU29ydEdyaWRHcm91cCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zb3J0U2VydmljZS5zb3J0KHRoaXMuZWwubmF0aXZlRWxlbWVudCk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdkcmFnb3ZlcicsIFsnJGV2ZW50J10pXG4gIGRyYWdPdmVyKGV2ZW50KTogYm9vbGVhbiB7XG4gICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KSB7XG4gICAgICAvLyBOZWNlc3NhcnkuIEFsbG93cyB1cyB0byBkcm9wLlxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignZHJhZ2VuZCcpXG4gIGRyb3AoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLm5nc2dTdG9yZS5oYXNTZWxlY3RlZEl0ZW1zKHRoaXMubmdTb3J0R3JpZEdyb3VwKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5uZ3NnU3RvcmUuaGFzSXRlbXModGhpcy5uZ1NvcnRHcmlkR3JvdXApKSB7XG4gICAgICBjb25zb2xlLndhcm4oYE5nLXNvcnRncmlkOiBObyBpdGVtcyBwcm92aWRlZCAtIHBsZWFzZSB1c2UgW3NvcnRHcmlkSXRlbXNdIHRvIHBhc3MgaW4gYW4gYXJyYXkgb2YgaXRlbXMgLVxuICAgICAgb3RoZXJ3aGlzZSB0aGUgb3JkZXJlZCBpdGVtcyBjYW4gbm90IGJlIGVtaXR0ZWQgaW4gdGhlIChzb3J0ZWQpIGV2ZW50YCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHByZXZpb3VzT3JkZXIgPSBbLi4udGhpcy5uZ3NnU3RvcmUuZ2V0SXRlbXModGhpcy5uZ1NvcnRHcmlkR3JvdXApXTtcbiAgICB0aGlzLnNvcnRTZXJ2aWNlLmVuZFNvcnQoKTtcbiAgICBjb25zdCBjdXJyZW50T3JkZXIgPSB0aGlzLnJlZmxlY3RTZXJ2aWNlLnJlZmxlY3RDaGFuZ2VzKHRoaXMubmdTb3J0R3JpZEdyb3VwLCB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQpO1xuICAgIHRoaXMuc29ydGVkLm5leHQoe3ByZXZpb3VzT3JkZXIsIGN1cnJlbnRPcmRlcn0pO1xuICAgIHRoaXMubmdzZ1N0b3JlLnJlc2V0U2VsZWN0ZWRJdGVtcyh0aGlzLm5nU29ydEdyaWRHcm91cCk7XG4gICAgdGhpcy5uZ3NnRXZlbnRTZXJ2aWNlLmRyb3BwZWQkLm5leHQoKTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJylcbiAgY2xpY2tlZCgpOiB2b2lkIHtcbiAgICB0aGlzLnNlbGVjdGVkID0gIXRoaXMuaXNJdGVtQ3VycmVudGx5U2VsZWN0ZWQoKTtcbiAgICB0aGlzLnNlbGVjdGlvblNlcnZpY2UudXBkYXRlU2VsZWN0ZWREcmFnSXRlbSh0aGlzLm5nU29ydEdyaWRHcm91cCwgdGhpcy5lbC5uYXRpdmVFbGVtZW50LCB0aGlzLnNlbGVjdGVkKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNJdGVtQ3VycmVudGx5U2VsZWN0ZWQoKTogYm9vbGVhbiB7XG4gICAgY29uc3QgaW5kZXggPSBOZ3NnRWxlbWVudHNIZWxwZXIuZmluZEluZGV4KHRoaXMuZWwubmF0aXZlRWxlbWVudCk7XG4gICAgcmV0dXJuICEhdGhpcy5uZ3NnU3RvcmUuZ2V0U2VsZWN0ZWRJdGVtcyh0aGlzLm5nU29ydEdyaWRHcm91cClcbiAgICAgIC5maW5kKGVsZW1lbnQgPT4gZWxlbWVudC5vcmlnaW5hbEluZGV4ID09PSBpbmRleCk7XG4gIH1cblxuICBwcml2YXRlIG9jY3VyZWRPbkhvc3QoZXZlbnQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZXZlbnQudGFyZ2V0Lm1hdGNoZXMoc2VsZWN0b3IpO1xuICB9XG59XG4iXX0=